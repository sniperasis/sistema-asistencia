<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App M√≥vil - Sistema de Asistencia</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Asistencia App">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .employee-list {
            display: none;
            padding: 30px;
            min-height: 400px;
            background: white;
            position: relative;
            z-index: 10;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
        }

        .employee-list.active {
            display: block;
            visibility: visible;
            opacity: 1;
            background: white;
            position: relative;
            z-index: 10;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }


        .employee-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }

        .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .employee-card.presente {
            border-left-color: #28a745;
        }

        .employee-card.ausente {
            border-left-color: #dc3545;
        }

        .employee-card.pendiente {
            border-left-color: #ffc107;
        }

        .employee-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .employee-details h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .employee-details p {
            color: #6c757d;
            margin-bottom: 5px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-badge.presente {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.ausente {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .success-message {
            text-align: center;
            padding: 40px;
            color: #28a745;
            font-size: 1.1rem;
        }

        .error-message {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            font-size: 1.1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
            
            .employee-info {
                flex-direction: column;
                gap: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± App M√≥vil</h1>
            <p>Sistema de Asistencia - Tablet</p>
            <div id="info-sesion" style="margin-top: 15px; font-size: 1rem; opacity: 0.9;">
                <div>üìÖ <strong>Fecha:</strong> <span id="fecha-sesion">02/09/2025</span></div>
                <div>üïê <strong>Turno:</strong> <span id="turno-sesion">TERCERO</span></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('pendientes')" id="tab-pendientes">
                ‚è≥ Pendientes
            </button>
            <button class="tab" onclick="showTab('presentes')" id="tab-presentes">
                ‚úÖ Presentes
            </button>
            <button class="tab" onclick="showTab('ausentes')" id="tab-ausentes">
                ‚ùå Ausentes
            </button>
            <button class="tab" onclick="showTab('qr')" id="tab-qr">
                üì∑ Escanear QR
            </button>
        </div>

        <!-- Pesta√±a Pendientes -->
        <div id="pendientes" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-empleados">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="presentes">0</div>
                    <div class="stat-label">Presentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ausentes">0</div>
                    <div class="stat-label">Ausentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendientes-count">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
            </div>

            <div id="employee-list" class="employee-list">
                <div class="success-message">
                    ‚è≥ Cargando empleados...<br>
                    <small>Conectando con el servidor</small>
                </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="guardarAsistencia()" style="min-width: 200px;">
                    üíæ Guardar Asistencia
                </button>
                <button class="btn btn-danger" onclick="limpiarAsistencia()" style="min-width: 200px;">
                    üóëÔ∏è Limpiar Asistencia
                </button>
            </div>
        </div>

        <!-- Pesta√±a Presentes -->
        <div id="presentes" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-presentes">0</div>
                    <div class="stat-label">Total Presentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="presentes-manual">0</div>
                    <div class="stat-label">Marcado Manual</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="presentes-qr">0</div>
                    <div class="stat-label">Marcado QR</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="porcentaje-asistencia">0%</div>
                    <div class="stat-label">% Asistencia</div>
                </div>
            </div>

            <div id="employee-list-presentes" class="employee-list">
                <div class="success-message">
                    ‚úÖ Empleados que han marcado asistencia<br>
                    <small>Lista de personal presente</small>
                </div>
            </div>
        </div>

        <!-- Pesta√±a Ausentes -->
        <div id="ausentes" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-ausentes">0</div>
                    <div class="stat-label">Total Ausentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ausentes-manual">0</div>
                    <div class="stat-label">Marcado Manual</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ausentes-automatico">0</div>
                    <div class="stat-label">Sin Marcar</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="porcentaje-ausentismo">0%</div>
                    <div class="stat-label">% Ausentismo</div>
                </div>
            </div>

            <div id="employee-list-ausentes" class="employee-list">
                <div class="success-message">
                    ‚ùå Empleados ausentes<br>
                    <small>Personal que no ha marcado asistencia</small>
                </div>
            </div>
        </div>

        <div id="qr" class="tab-content">
            <div style="text-align: center; padding: 40px;">
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #333; margin-bottom: 15px;">üì∑ Esc√°ner de C√≥digos QR</h3>
                    <p style="color: #666; margin-bottom: 20px;">Escanea el c√≥digo QR del empleado para marcar asistencia autom√°ticamente</p>
                </div>
                
                <div style="width: 300px; height: 300px; background: linear-gradient(45deg, #f8f9fa, #e9ecef); border: 3px solid #667eea; border-radius: 20px; margin: 0 auto 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.2rem; color: #667eea; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 20px; left: 20px; width: 20px; height: 20px; border: 3px solid #667eea; border-right: none; border-bottom: none;"></div>
                    <div style="position: absolute; top: 20px; right: 20px; width: 20px; height: 20px; border: 3px solid #667eea; border-left: none; border-bottom: none;"></div>
                    <div style="position: absolute; bottom: 20px; left: 20px; width: 20px; height: 20px; border: 3px solid #667eea; border-right: none; border-top: none;"></div>
                    <div style="position: absolute; bottom: 20px; right: 20px; width: 20px; height: 20px; border: 3px solid #667eea; border-left: none; border-top: none;"></div>
                    
                    <div style="font-size: 3rem; margin-bottom: 15px;">üì∑</div>
                    <div style="font-weight: 600; margin-bottom: 10px;">√Årea de Escaneo</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Coloca el c√≥digo QR aqu√≠</div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="simularEscaneo()" style="min-width: 200px;">
                        üîÑ Simular Escaneo QR
                    </button>
                    <button class="btn btn-success" onclick="activarCamara()" style="min-width: 200px;">
                        üìπ Activar C√°mara
                    </button>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                    <h4 style="color: #333; margin-bottom: 15px;">üìã Instrucciones:</h4>
                    <ul style="list-style: none; padding: 0; color: #666;">
                        <li style="margin-bottom: 8px;">‚úì Aseg√∫rate de que el c√≥digo QR est√© bien iluminado</li>
                        <li style="margin-bottom: 8px;">‚úì Mant√©n el c√≥digo QR dentro del √°rea de escaneo</li>
                        <li style="margin-bottom: 8px;">‚úì El empleado ser√° marcado autom√°ticamente como PRESENTE</li>
                        <li style="margin-bottom: 8px;">‚úì Si no funciona, usa el bot√≥n "Simular Escaneo QR"</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let empleados = [];
        let fechaSesion = "02/09/2025";
        let turnoSesion = "TERCERO";

        // Funci√≥n para mostrar pesta√±as - SOLUCI√ìN DEFINITIVA
        function showTab(tabName) {
            console.log('=== CAMBIANDO A PESTA√ëA:', tabName, '===');
            
            // PASO 1: Ocultar TODOS los contenedores
            const allContainers = [
                'employee-list',
                'employee-list-presentes', 
                'employee-list-ausentes'
            ];
            
            allContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.style.display = 'none';
                    container.classList.remove('active');
                    console.log('Ocultando contenedor:', id);
                }
            });
            
            // PASO 2: Desactivar todos los botones
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // PASO 3: Activar el bot√≥n correcto
            const tabButton = document.getElementById(`tab-${tabName}`);
            if (tabButton) {
                tabButton.classList.add('active');
                console.log('Bot√≥n activado:', tabName);
            }
            
            // PASO 4: Mostrar el contenedor correcto y cargar contenido
            let targetContainerId = '';
            let loadFunction = null;
            
            if (tabName === 'pendientes') {
                targetContainerId = 'employee-list';
                loadFunction = () => mostrarEmpleados();
            } else if (tabName === 'presentes') {
                targetContainerId = 'employee-list-presentes';
                loadFunction = () => mostrarEmpleadosPresentes();
            } else if (tabName === 'ausentes') {
                targetContainerId = 'employee-list-ausentes';
                loadFunction = () => mostrarEmpleadosAusentes();
            } else if (tabName === 'qr') {
                targetContainerId = 'qr';
                loadFunction = () => mostrarEscanerQR();
            }
            
            if (targetContainerId && loadFunction) {
                const targetContainer = document.getElementById(targetContainerId);
                if (targetContainer) {
                    // Mostrar contenedor
                    targetContainer.style.display = 'block';
                    targetContainer.classList.add('active');
                    console.log('Mostrando contenedor:', targetContainerId);
                    
                    // Cargar contenido
                    setTimeout(() => {
                        console.log('Cargando contenido para:', tabName);
                        loadFunction();
                    }, 50);
                } else {
                    console.error('No se encontr√≥ contenedor:', targetContainerId);
                }
            }
        }

        // Cargar empleados desde el servidor
        async function cargarEmpleados() {
            try {
                const response = await fetch(`http://localhost:3000/api/empleados?fecha=${new Date().toISOString().split('T')[0]}`);
                const data = await response.json();
                
                if (data.success) {
                    empleados = data.empleados;
                    mostrarEmpleados();
                    actualizarEstadisticas();
                    mostrarNotificacion(`‚úÖ ${empleados.length} empleados cargados correctamente`, 'success');
                } else {
                    mostrarError('Error al cargar empleados: ' + data.message);
                }
            } catch (error) {
                mostrarError('Error de conexi√≥n: ' + error.message);
                // Mostrar datos de prueba si no hay conexi√≥n
                mostrarEmpleadosPrueba();
            }
        }

        // Mostrar empleados - VERSI√ìN SIMPLIFICADA
        function mostrarEmpleados() {
            console.log('=== MOSTRANDO EMPLEADOS PENDIENTES ===');
            console.log('Empleados disponibles:', empleados.length);
            
            const container = document.getElementById('employee-list');
            if (!container) {
                console.error('Contenedor employee-list no encontrado');
                return;
            }
            
            // Asegurar visibilidad del contenedor
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            container.style.background = 'white';
            container.style.position = 'relative';
            container.style.zIndex = '10';
            container.style.minHeight = '400px';
            
            if (empleados.length === 0) {
                container.innerHTML = `
                    <div class="success-message">
                        ‚ö†Ô∏è No hay empleados cargados<br>
                        <small>Primero debes cargar un archivo Excel desde el panel principal</small>
                    </div>
                `;
                return;
            }
            let html = '';
            
            empleados.forEach(empleado => {
                const estadoClass = empleado.estado.toLowerCase();
                html += `
                    <div class="employee-card ${estadoClass}">
                        <div class="employee-info">
                            <div class="employee-details">
                                <h3>${empleado.nombres} ${empleado.apellidos}</h3>
                                <p><strong>RUT:</strong> ${empleado.rut}</p>
                                <p><strong>Especialidad:</strong> ${empleado.especialidad}</p>
                                ${empleado.hora !== '-' ? `<p><strong>Hora:</strong> ${empleado.hora}</p>` : ''}
                            </div>
                            <div class="status-badge ${estadoClass}">
                                ${empleado.estado}
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="marcarAsistencia(${empleado.id}, 'PRESENTE')">
                                ‚úÖ Presente
                            </button>
                            <button class="btn btn-danger" onclick="marcarAsistencia(${empleado.id}, 'AUSENTE')">
                                ‚ùå Ausente
                            </button>
                            <button class="btn btn-warning" onclick="marcarAsistencia(${empleado.id}, 'PENDIENTE')">
                                ‚è≥ Pendiente
                            </button>
                        </div>
                    </div>
                `;
            });
            
            console.log('HTML generado para pendientes:', html.length, 'caracteres');
            container.innerHTML = html;
            console.log('HTML insertado en contenedor pendientes');
            
            // Verificar que el contenido sea visible
            setTimeout(() => {
                console.log('Verificando visibilidad del contenedor...');
                console.log('Display:', window.getComputedStyle(container).display);
                console.log('Visibility:', window.getComputedStyle(container).visibility);
                console.log('Opacity:', window.getComputedStyle(container).opacity);
                console.log('Contenido del contenedor:', container.innerHTML.length, 'caracteres');
            }, 200);
        }

        // Mostrar empleados presentes - VERSI√ìN SIMPLIFICADA
        function mostrarEmpleadosPresentes() {
            console.log('=== MOSTRANDO EMPLEADOS PRESENTES ===');
            const presentes = empleados.filter(e => e.estado === 'PRESENTE');
            const container = document.getElementById('employee-list-presentes');
            
            console.log('Empleados presentes encontrados:', presentes.length);
            
            if (!container) {
                console.error('Contenedor employee-list-presentes no encontrado');
                return;
            }
            
            // Asegurar visibilidad del contenedor
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            container.style.background = 'white';
            container.style.position = 'relative';
            container.style.zIndex = '10';
            container.style.minHeight = '400px';
            
            if (presentes.length === 0) {
                container.innerHTML = `
                    <div class="success-message">
                        üìã No hay empleados presentes<br>
                        <small>Los empleados marcados como presentes aparecer√°n aqu√≠</small>
                    </div>
                `;
                return;
            }

            let html = '';
            presentes.forEach(empleado => {
                html += `
                    <div class="employee-card presente">
                        <div class="employee-info">
                            <div class="employee-details">
                                <h3>${empleado.nombres} ${empleado.apellidos}</h3>
                                <p><strong>RUT:</strong> ${empleado.rut}</p>
                                <p><strong>Especialidad:</strong> ${empleado.especialidad}</p>
                                <p><strong>Hora:</strong> ${empleado.hora}</p>
                                <p><strong>Tipo:</strong> ${empleado.tipo}</p>
                            </div>
                            <div class="status-badge presente">
                                ${empleado.estado}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            console.log('HTML generado para presentes:', html.length, 'caracteres');
            container.innerHTML = html;
            console.log('HTML insertado en contenedor');
            
            // Debug espec√≠fico para presentes
            setTimeout(() => {
                console.log('=== DEBUG PRESENTES ===');
                console.log('Contenedor:', container);
                console.log('Clases del contenedor:', container.className);
                console.log('Display computado:', window.getComputedStyle(container).display);
                console.log('Contenido HTML:', container.innerHTML.substring(0, 200) + '...');
                console.log('Elementos hijos:', container.children.length);
            }, 100);
        }

        // Mostrar empleados ausentes - VERSI√ìN SIMPLIFICADA
        function mostrarEmpleadosAusentes() {
            console.log('=== MOSTRANDO EMPLEADOS AUSENTES ===');
            const ausentes = empleados.filter(e => e.estado === 'AUSENTE');
            const container = document.getElementById('employee-list-ausentes');
            
            console.log('Empleados ausentes encontrados:', ausentes.length);
            
            if (!container) {
                console.error('Contenedor employee-list-ausentes no encontrado');
                return;
            }
            
            // Asegurar visibilidad del contenedor
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            container.style.background = 'white';
            container.style.position = 'relative';
            container.style.zIndex = '10';
            container.style.minHeight = '400px';
            
            if (ausentes.length === 0) {
                container.innerHTML = `
                    <div class="success-message">
                        üìã No hay empleados ausentes<br>
                        <small>Los empleados marcados como ausentes aparecer√°n aqu√≠</small>
                    </div>
                `;
                return;
            }

            let html = '';
            ausentes.forEach(empleado => {
                html += `
                    <div class="employee-card ausente">
                        <div class="employee-info">
                            <div class="employee-details">
                                <h3>${empleado.nombres} ${empleado.apellidos}</h3>
                                <p><strong>RUT:</strong> ${empleado.rut}</p>
                                <p><strong>Especialidad:</strong> ${empleado.especialidad}</p>
                                <p><strong>Hora:</strong> ${empleado.hora}</p>
                                <p><strong>Tipo:</strong> ${empleado.tipo}</p>
                            </div>
                            <div class="status-badge ausente">
                                ${empleado.estado}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            console.log('HTML generado para ausentes:', html.length, 'caracteres');
            container.innerHTML = html;
            console.log('HTML insertado en contenedor');
        }

        // Mostrar empleados de prueba (fallback)
        function mostrarEmpleadosPrueba() {
            empleados = [
                {
                    id: 1,
                    rut: "12345678-9",
                    nombres: "JUAN CARLOS",
                    apellidos: "GONZ√ÅLEZ P√âREZ",
                    especialidad: "OPERADOR MUELLE",
                    estado: "PENDIENTE",
                    hora: "-",
                    tipo: "-",
                    fecha: fechaSesion,
                    turno: turnoSesion
                },
                {
                    id: 2,
                    rut: "98765432-1",
                    nombres: "MAR√çA ELENA",
                    apellidos: "MART√çNEZ L√ìPEZ",
                    especialidad: "SUPERVISOR MUELLE",
                    estado: "PENDIENTE",
                    hora: "-",
                    tipo: "-",
                    fecha: fechaSesion,
                    turno: turnoSesion
                }
            ];
            mostrarEmpleados();
            actualizarEstadisticas();
            mostrarNotificacion('‚ö†Ô∏è Modo de prueba - Datos limitados', 'warning');
        }

        // Marcar asistencia
        async function marcarAsistencia(id, estado) {
            const empleado = empleados.find(e => e.id === id);
            if (!empleado) return;

            try {
                const response = await fetch('http://localhost:3000/api/marcar-asistencia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        estado: estado,
                        fecha: new Date().toISOString().split('T')[0],
                        hora: new Date().toTimeString().split(' ')[0],
                        tipo_marcado: 'manual'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Actualizar estado local
                    empleado.estado = estado;
                    empleado.hora = new Date().toTimeString().split(' ')[0];
                    empleado.tipo = 'MANUAL';
                    
                    // Refrescar la vista
                    mostrarEmpleados();
                    actualizarEstadisticas();
                    
                    // Actualizar pesta√±as si est√°n activas
                    if (document.getElementById('presentes').classList.contains('active')) {
                        mostrarEmpleadosPresentes();
                    }
                    if (document.getElementById('ausentes').classList.contains('active')) {
                        mostrarEmpleadosAusentes();
                    }
                    
                    mostrarNotificacion(`‚úÖ ${empleado.nombres} marcado como ${estado}`, 'success');
                } else {
                    mostrarError('Error al marcar asistencia: ' + data.message);
                }
            } catch (error) {
                // Fallback local si no hay conexi√≥n
                empleado.estado = estado;
                empleado.hora = new Date().toTimeString().split(' ')[0];
                empleado.tipo = 'MANUAL';
                
                mostrarEmpleados();
                actualizarEstadisticas();
                
                // Actualizar pesta√±as si est√°n activas
                if (document.getElementById('presentes').classList.contains('active')) {
                    mostrarEmpleadosPresentes();
                }
                if (document.getElementById('ausentes').classList.contains('active')) {
                    mostrarEmpleadosAusentes();
                }
                
                mostrarNotificacion(`‚úÖ ${empleado.nombres} marcado como ${estado} (modo local)`, 'success');
            }
        }

        // Actualizar estad√≠sticas
        function actualizarEstadisticas() {
            const total = empleados.length;
            const presentes = empleados.filter(e => e.estado === 'PRESENTE');
            const ausentes = empleados.filter(e => e.estado === 'AUSENTE');
            const pendientes = empleados.filter(e => e.estado === 'PENDIENTE');

            // Estad√≠sticas generales
            document.getElementById('total-empleados').textContent = total;
            document.getElementById('presentes').textContent = presentes.length;
            document.getElementById('ausentes').textContent = ausentes.length;
            document.getElementById('pendientes-count').textContent = pendientes.length;

            // Estad√≠sticas de presentes
            const presentesManual = presentes.filter(e => e.tipo === 'MANUAL' || e.tipo === 'manual').length;
            const presentesQR = presentes.filter(e => e.tipo === 'QR' || e.tipo === 'qr').length;
            const porcentajeAsistencia = total > 0 ? Math.round((presentes.length / total) * 100) : 0;

            document.getElementById('total-presentes').textContent = presentes.length;
            document.getElementById('presentes-manual').textContent = presentesManual;
            document.getElementById('presentes-qr').textContent = presentesQR;
            document.getElementById('porcentaje-asistencia').textContent = porcentajeAsistencia + '%';

            // Estad√≠sticas de ausentes
            const ausentesManual = ausentes.filter(e => e.tipo === 'MANUAL' || e.tipo === 'manual').length;
            const ausentesAutomatico = ausentes.length - ausentesManual;
            const porcentajeAusentismo = total > 0 ? Math.round((ausentes.length / total) * 100) : 0;

            document.getElementById('total-ausentes').textContent = ausentes.length;
            document.getElementById('ausentes-manual').textContent = ausentesManual;
            document.getElementById('ausentes-automatico').textContent = ausentesAutomatico;
            document.getElementById('porcentaje-ausentismo').textContent = porcentajeAusentismo + '%';
        }

        // Mostrar esc√°ner QR
        function mostrarEscanerQR() {
            console.log('=== MOSTRANDO ESC√ÅNER QR ===');
            const container = document.getElementById('qr');
            
            if (!container) {
                console.error('Contenedor QR no encontrado');
                return;
            }
            
            // Asegurar visibilidad del contenedor
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            container.style.background = 'white';
            container.style.position = 'relative';
            container.style.zIndex = '10';
            container.style.minHeight = '400px';
            
            console.log('Esc√°ner QR mostrado correctamente');
        }

        // Simular escaneo QR
        function simularEscaneo() {
            const empleadoAleatorio = empleados[Math.floor(Math.random() * empleados.length)];
            if (empleadoAleatorio) {
                marcarAsistencia(empleadoAleatorio.id, 'PRESENTE');
                mostrarNotificacion(`üì∑ QR escaneado: ${empleadoAleatorio.nombres}`, 'success');
            } else {
                mostrarNotificacion('‚ö†Ô∏è No hay empleados disponibles para simular escaneo', 'warning');
            }
        }

        // Activar c√°mara para escaneo QR
        function activarCamara() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                mostrarNotificacion('üìπ Activando c√°mara...', 'success');
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function(stream) {
                        mostrarNotificacion('‚úÖ C√°mara activada. Funcionalidad de escaneo QR en desarrollo.', 'success');
                        // Aqu√≠ se implementar√≠a la l√≥gica de escaneo QR real
                        // Por ahora, solo mostramos que la c√°mara est√° activa
                    })
                    .catch(function(error) {
                        console.error('Error al acceder a la c√°mara:', error);
                        mostrarNotificacion('‚ùå No se pudo acceder a la c√°mara. Usa "Simular Escaneo QR"', 'error');
                    });
            } else {
                mostrarNotificacion('‚ùå Tu dispositivo no soporta acceso a la c√°mara. Usa "Simular Escaneo QR"', 'error');
            }
        }

        // Guardar asistencia en Excel
        function guardarAsistencia() {
            if (empleados.length === 0) {
                mostrarNotificacion('‚ö†Ô∏è No hay empleados para guardar', 'warning');
                return;
            }

            // Preparar datos para Excel
            const datosExcel = empleados.map(empleado => ({
                'RUT': empleado.rut,
                'Nombres': empleado.nombres,
                'Apellidos': empleado.apellidos,
                'Especialidad': empleado.especialidad,
                'Estado': empleado.estado,
                'Hora': empleado.hora,
                'Tipo': empleado.tipo,
                'Fecha': empleado.fecha,
                'Turno': empleado.turno
            }));

            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datosExcel);

            // Ajustar ancho de columnas
            ws['!cols'] = [
                { width: 15 }, // RUT
                { width: 20 }, // Nombres
                { width: 20 }, // Apellidos
                { width: 25 }, // Especialidad
                { width: 12 }, // Estado
                { width: 10 }, // Hora
                { width: 10 }, // Tipo
                { width: 12 }, // Fecha
                { width: 10 }  // Turno
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Asistencia');

            // Generar archivo
            const nombreArchivo = `asistencia_${fechaSesion.replace(/\//g, '-')}_${turnoSesion}.xlsx`;
            XLSX.writeFile(wb, nombreArchivo);

            mostrarNotificacion(`üíæ Archivo guardado: ${nombreArchivo}`, 'success');
        }

        // Limpiar asistencia
        async function limpiarAsistencia() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar toda la asistencia?')) {
                try {
                    const response = await fetch('http://localhost:3000/api/limpiar-asistencia', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            fecha: new Date().toISOString().split('T')[0]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        // Actualizar estado local
                        empleados.forEach(empleado => {
                            empleado.estado = 'PENDIENTE';
                            empleado.hora = '-';
                            empleado.tipo = '-';
                        });
                        
                        // Refrescar todas las vistas
                        mostrarEmpleados();
                        actualizarEstadisticas();
                        
                        // Actualizar pesta√±as si est√°n activas
                        if (document.getElementById('presentes').classList.contains('active')) {
                            mostrarEmpleadosPresentes();
                        }
                        if (document.getElementById('ausentes').classList.contains('active')) {
                            mostrarEmpleadosAusentes();
                        }
                        
                        mostrarNotificacion('üóëÔ∏è Asistencia limpiada correctamente', 'success');
                    } else {
                        mostrarError('Error al limpiar asistencia: ' + data.error);
                    }
                } catch (error) {
                    // Fallback local si no hay conexi√≥n
                    empleados.forEach(empleado => {
                        empleado.estado = 'PENDIENTE';
                        empleado.hora = '-';
                        empleado.tipo = '-';
                    });
                    
                    mostrarEmpleados();
                    actualizarEstadisticas();
                    
                    // Actualizar pesta√±as si est√°n activas
                    if (document.getElementById('presentes').classList.contains('active')) {
                        mostrarEmpleadosPresentes();
                    }
                    if (document.getElementById('ausentes').classList.contains('active')) {
                        mostrarEmpleadosAusentes();
                    }
                    
                    mostrarNotificacion('üóëÔ∏è Asistencia limpiada (modo local)', 'success');
                }
            }
        }

        // Mostrar notificaci√≥n
        function mostrarNotificacion(mensaje, tipo) {
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensaje;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Mostrar error
        function mostrarError(mensaje) {
            mostrarNotificacion(mensaje, 'error');
        }

        // Inicializar la app
        document.addEventListener('DOMContentLoaded', () => {
            cargarEmpleados();
            
            // Actualizar cada 30 segundos
            setInterval(cargarEmpleados, 30000);
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registrado:', registration);
                    })
                    .catch((error) => {
                        console.log('Error al registrar Service Worker:', error);
                    });
            }
        });
    </script>
</body>
</html>